╔═══════════════════════════════════════════════════════════════╗
║                  WEBSOCKET FIX - RUN THIS                     ║
╚═══════════════════════════════════════════════════════════════╝

ROOT CAUSE IDENTIFIED:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Nginx is serving static files from WRONG directory:

  Django collectstatic puts files in:  /var/www/scan2food/static
  Nginx is configured to serve from:   /var/www/scan2food/staticfiles ❌

This is why:
  ✓ API key exists in file on disk
  ❌ API key NOT in file served by Nginx
  ❌ WebSocket connections rejected (no key in URL)


THE FIX (Run on server):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

cd /var/www/scan2food
bash FIX_EVERYTHING_NOW.sh


WHAT THE SCRIPT DOES:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Diagnoses current state
2. Fixes Nginx static path (staticfiles → static)
3. Adds cache control headers for JS files
4. Verifies static files have API keys
5. Tests what Nginx actually serves
6. Checks all services are running
7. Shows recent Daphne logs


AFTER RUNNING:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Users must HARD REFRESH browser (Ctrl + Shift + R)

2. Check browser console - WebSocket URL should be:
   wss://calculatentrade.com/ws/all-seat-datasocket/?key=05XnhaghUWM6Hd7YVR6_iPcJGfH_YDn3RiDv1Rh-zNM

3. Monitor Daphne logs:
   sudo journalctl -u daphne -f
   
   Should see: WSCONNECT (not WSREJECT)


MANUAL FIX (if script fails):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# 1. Backup Nginx config
sudo cp /etc/nginx/sites-available/scan2food /etc/nginx/sites-available/scan2food.backup

# 2. Fix the path
sudo sed -i 's|/var/www/scan2food/staticfiles/|/var/www/scan2food/static/|g' /etc/nginx/sites-available/scan2food

# 3. Test and restart
sudo nginx -t
sudo systemctl restart nginx

# 4. Verify
curl -s https://calculatentrade.com/static/theatre_js/live-orders/worker.js | grep "05XnhaghUWM6Hd7YVR6"


VERIFICATION:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

# Check file on disk
grep "05XnhaghUWM6Hd7YVR6" /var/www/scan2food/static/theatre_js/live-orders/worker.js
→ Should show: ✓ Found

# Check what Nginx serves
curl -s https://calculatentrade.com/static/theatre_js/live-orders/worker.js | grep "05XnhaghUWM6Hd7YVR6"
→ Should show: ✓ Found (after fix)


IMPORTANT NOTES:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️  This is NOT a browser cache issue
⚠️  This is NOT a collectstatic issue
⚠️  This IS an Nginx configuration issue

The consumer code is correct.
The static files are correct.
The Nginx path is WRONG.


SECURITY CONCERN:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Current API key system works but is weak:
  • Keys are visible in browser DevTools
  • Anyone can copy and reuse keys
  • No per-user tracking

Better solution: Session-based authentication
  • See: BETTER_WEBSOCKET_AUTH.md
  • Uses Django sessions (already logged in users)
  • No keys in frontend code
  • More secure

After confirming WebSockets work, consider migrating to session auth.


FILES CREATED:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

• FIX_EVERYTHING_NOW.sh          - Complete automated fix
• ROOT_CAUSE_ANALYSIS.md         - Detailed analysis
• BETTER_WEBSOCKET_AUTH.md       - Session auth migration guide
• CRITICAL_FIXES_RUN_NOW.sh      - Alternative fix script
• fix_websocket_issues.sh        - Diagnostic script


QUESTIONS?
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Read: ROOT_CAUSE_ANALYSIS.md for full details

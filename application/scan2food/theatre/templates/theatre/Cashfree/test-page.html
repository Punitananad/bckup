{% extends "theatre/base.html" %}

{% load static %}
{% block title %}


{% endblock %}

{% block content %}
<div class="pageWrapper" id="paymentPage">
    <!-- templates/payment_page.html -->

    <div class="row align-items-center justify-content-center m-0">
        <div class="container text-center">
            <h5 class="section-title ff-secondary text-center text-primary fw-normal">Payment Details</h5>
            <div class="card rounded-2 mt-4 mb-3">
                <div class="card-body">


                    <!-- <div class="d-flex justify-content-between">
                        <p class="text-muted" id="payment-tab-panding-amount-heading">Order Amount

                        </p>
                        <h6 class="total-amount">₹ <span class="amount-with-tax">{{amount}}</span>
                        </h6>
                    </div> -->

                    <hr>
                    <div class="d-flex justify-content-between">
                        <p class="text-muted">Total Amount</p>
                        <h6 class="total-amount">₹ <span class="amount-with-tax">{{amount}}</span></h6>
                    </div>


                    <div class="d-flex justify-content-center">
                        <!-- {% if request.user.is_anonymous %}
                        <div class="text-center mt-4 mx-2">
                            <a href="{% url 'theatre:generate-cash-order' order.pk %}"
                                class="btn btn-secondary btn-custom">Pay by Cash</a>
                        </div>

                        {% else %}
                        <div class="text-center mt-4 mx-2">
                            <a href="{% url 'theatre:add-payment-manually' order.id %}"
                                class="btn btn-secondary btn-custom">Pay by Cash</a>
                        </div>
                        {% endif %} -->

                        <div class="text-center mt-4 mx-2">

                            <form action="/" method="POST">
                                <div class="row">
                                    
                                    <select name="" id="target" class="form-control">
                                        <option value="_self">self</option>
                                        <option value="_blank">blank</option>
                                        <option value="_top">TOP</option>
                                        <option value="_modal">MODAL</option>
                                    </select>

                                    <button class="btn btn-primary" type="button" onclick="submitForm()"
                                        id="rzp-button1">Pay</button>

                                    {% if request.user.is_anonymous %}
                                    <button class="d-none"></button>

                                    <div class="col-lg-6 col-md-6 col-12 col-sm-6">
                                        {% else %}

                                        <a href="{% url 'theatre:cancel-cash-order' order.id%}"
                                            class="btn btn-danger btn-custom">Cancel Order</a>
    
                                        {% endif %}

                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

<script>
    /// initilise the sdk
    const cashfree = Cashfree({
        mode: "production" //or production , sandbox for testing
    });

    const submitForm = () => {

        target_value = document.getElementById('target').value;
        let checkoutOptions = {
            paymentSessionId: "{{cashfree_detail.payment_session_id}}",
            returnUrl: "{{redirect_url}}",
            redirectTarget: target_value
        };
        // cashfree.checkout(checkoutOptions).then(function (result) {
        //     if (result.error) {
        //         alert(result.error.message);
        //     }
        //     if (result.redirect) {
        //         console.log("Redirection");
        //     }
        // });

        cashfree.checkout(checkoutOptions).then((result) => {
            if (result.error) {
                // This will be true whenever user clicks on close icon inside the modal or any error happens during the payment
                console.log("User has closed the popup or there is some payment error, Check for Payment Status");
                console.log(result.error);
            }
            if (result.redirect) {
                // This will be true when the payment redirection page couldnt be opened in the same window
                // This is an exceptional case only when the page is opened inside an inAppBrowser
                // In this case the customer will be redirected to return url once payment is completed
                console.log("Payment will be redirected");
            }
            if (result.paymentDetails) {
                // This will be called whenever the payment is completed irrespective of transaction status
                console.log("Payment has been completed, Check for Payment Status");
                console.log(result.paymentDetails.paymentMessage);
            }
        });

    }
</script>


{{order.id|json_script:"order-id"}}


{% endblock %}